<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miscellaneous notes • visiumStitched</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Miscellaneous notes">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">visiumStitched</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.99.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/visiumStitched.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/misc.html">Miscellaneous notes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/LieberInstitute/visiumStitched/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Miscellaneous notes</h1>
                        <h4 data-toc-skip class="author">Nicholas J.
Eagles</h4>
            <address class="author_afil">
      Lieber Institute for Brain
Development<br><a class="author_email" href="mailto:#"></a><a href="mailto:nickeagles77@gmail.com" class="email">nickeagles77@gmail.com</a>
      </address>
                              <h4 data-toc-skip class="author">Leonardo
Collado-Torres</h4>
            <address class="author_afil">
      Lieber Institute for Brain DevelopmentCenter for Computational
Biology, Johns Hopkins UniversityDepartment of Biostatistics, Johns
Hopkins Bloomberg School of Public
Health<br><a class="author_email" href="mailto:#"></a><a href="mailto:lcolladotor@gmail.com" class="email">lcolladotor@gmail.com</a>
      </address>
                  
            <h4 data-toc-skip class="date">20 August 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/LieberInstitute/visiumStitched/blob/devel/vignettes/misc.Rmd" class="external-link"><code>vignettes/misc.Rmd</code></a></small>
      <div class="hidden name"><code>misc.Rmd</code></div>

    </div>

    
    
<p>This vignette has some extra companion notes to the <em>Introduction
to <code>visiumStiched</code></em> main vignette.</p>
<div class="section level2">
<h2 id="load-data">Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h2>
<p>Let’s load the <code>spatialLIBD</code> package we’ll use in this
vignette.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/LieberInstitute/spatialLIBD" class="external-link">"spatialLIBD"</a></span><span class="op">)</span></span></code></pre></div>
<p>Now we can download the example <code>visiumStitched_brain</code>
data that includes normalized <code>logcounts</code>. We’ll define the
same example white matter marker genes.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Grab SpatialExperiment with normalized counts</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/fetch_data.html" class="external-link">fetch_data</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"visiumStitched_brain_spe"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2024-08-20 20:44:28.401844 loading file /github/home/.cache/R/BiocFileCache/384f9f3410_visiumStitched_brain_spe.rds%3Frlkey%3Dnq6a82u23xuu9hohr86oodwdi%26dl%3D1</span></span>
<span></span>
<span><span class="co">## Check that spe does contain the "logcounts" assay</span></span>
<span><span class="fu">assayNames</span><span class="op">(</span><span class="va">spe</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "counts"    "logcounts"</span></span>
<span></span>
<span><span class="co">## Define white matter marker genes</span></span>
<span><span class="va">wm_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MBP"</span>, <span class="st">"GFAP"</span>, <span class="st">"PLP1"</span>, <span class="st">"AQP4"</span><span class="op">)</span>, <span class="fu">rowData</span><span class="op">(</span><span class="va">spe</span><span class="op">)</span><span class="op">$</span><span class="va">gene_name</span><span class="op">)</span></span>
<span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="geometric-transformations-notes">Geometric transformations notes<a class="anchor" aria-label="anchor" href="#geometric-transformations-notes"></a>
</h2>
<p>As a <code>SpatialExperiment</code>, the stitched data you
constructed with <code><a href="../reference/build_spe.html">visiumStitched::build_spe()</a></code> may need to be
rotated or mirrored by group. This can be done using the
<code><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-rotate-mirror.html" class="external-link">SpatialExperiment::rotateObject()</a></code> or
<code><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-rotate-mirror.html" class="external-link">SpatialExperiment::mirrorObject()</a></code> functions. These
functions are useful in case the image needs to be transformed to reach
the preferred tissue orientation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Rotate image and gene-expression data by 180 degrees, plotting a combination</span></span>
<span><span class="co">## of white-matter genes</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/vis_gene.html" class="external-link">vis_gene</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-rotate-mirror.html" class="external-link">rotateObject</a></span><span class="op">(</span><span class="va">spe</span>, sample_id <span class="op">=</span> <span class="st">"Br2719"</span>, degrees <span class="op">=</span> <span class="fl">180</span><span class="op">)</span>,</span>
<span>    geneid <span class="op">=</span> <span class="va">wm_genes</span>,</span>
<span>    assayname <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>    is_stitched <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    spatial <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="misc_files/figure-html/rotate-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Mirror image and gene-expression data across a vertical axis, plotting a</span></span>
<span><span class="co">## combination of white-matter genes</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/vis_gene.html" class="external-link">vis_gene</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-rotate-mirror.html" class="external-link">mirrorObject</a></span><span class="op">(</span><span class="va">spe</span>, sample_id <span class="op">=</span> <span class="st">"Br2719"</span>, axis <span class="op">=</span> <span class="st">"v"</span><span class="op">)</span>,</span>
<span>    geneid <span class="op">=</span> <span class="va">wm_genes</span>,</span>
<span>    assayname <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>    is_stitched <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    spatial <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="misc_files/figure-html/mirror-1.png" width="700"></p>
<p>You might want to re-make these plots with
<code>spatial = TRUE</code> so you can see how the histology image gets
rotated and/or mirrored. For file size purposes of this vignette, here
we had to use <code>spatial = FALSE</code>.</p>
<div class="section level3">
<h3 id="a-note-on-normalization">A note on normalization<a class="anchor" aria-label="anchor" href="#a-note-on-normalization"></a>
</h3>
<p>As noted <a href="https://research.libd.org/visiumStitched/articles/visiumStitched.html#stitched-plotting" class="external-link">in
the main vignette</a>, library-size variation across spots can bias the
apparent spatial distribution of genes when raw counts are used. The
effect is often dramatic enough that spatial trends cannot be easily
seen across the stitched data until data is log-normalized. Instead of
performing normalization here, we’ll fetch the object with <a href="https://bioconductor.org/books/3.19/OSCA.basic/normalization.html#normalization-by-deconvolution" class="external-link">normalized</a>
counts from <code>spatialLIBD</code>, then plot a few white matter genes
as before:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot combination of normalized counts for some white-matter genes</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/vis_gene.html" class="external-link">vis_gene</a></span><span class="op">(</span></span>
<span>    <span class="va">spe</span>,</span>
<span>    geneid <span class="op">=</span> <span class="va">wm_genes</span>,</span>
<span>    assayname <span class="op">=</span> <span class="st">"logcounts"</span>,</span>
<span>    is_stitched <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    spatial <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="misc_files/figure-html/fetch_norm-1.png" width="700"></p>
<p>Recall the unnormalized version of this plot, which is not nearly as
clean:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot raw counts, which are noisier</span></span>
<span><span class="co">## Same plot we made before, but this time with no histology images</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/vis_gene.html" class="external-link">vis_gene</a></span><span class="op">(</span></span>
<span>    <span class="va">spe</span>,</span>
<span>    geneid <span class="op">=</span> <span class="va">wm_genes</span>,</span>
<span>    assayname <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>    is_stitched <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    spatial <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="misc_files/figure-html/unnorm_plot-1.png" width="700"></p>
<p>The actual normalization code for this example data is available <a href="https://github.com/LieberInstitute/visiumStitched_brain/blob/01eae0b12848b4ecbb6fe2dc9c07ad4257df3e47/code/03_stitching/02_build_spe.R#L43-L76" class="external-link">here</a>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nicholas J. Eagles.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.9000.</p>
</div>

      </footer>
</div>






  </body>
</html>
