<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Miscellaneous notes • visiumStitched</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Miscellaneous notes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">visiumStitched</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.12</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/visiumStitched.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/misc.html">Miscellaneous notes</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/LieberInstitute/visiumStitched/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Miscellaneous notes</h1>
                        <h4 data-toc-skip class="author">Nicholas J.
Eagles</h4>
            <address class="author_afil">
      Lieber Institute for Brain
Development<br><a class="author_email" href="mailto:#"></a><a href="mailto:nickeagles77@gmail.com" class="email">nickeagles77@gmail.com</a>
      </address>
                              <h4 data-toc-skip class="author">Leonardo
Collado-Torres</h4>
            <address class="author_afil">
      Lieber Institute for Brain DevelopmentCenter for Computational
Biology, Johns Hopkins UniversityDepartment of Biostatistics, Johns
Hopkins Bloomberg School of Public
Health<br><a class="author_email" href="mailto:#"></a><a href="mailto:lcolladotor@gmail.com" class="email">lcolladotor@gmail.com</a>
      </address>
                  
            <h4 data-toc-skip class="date">18 October 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/LieberInstitute/visiumStitched/blob/devel/vignettes/misc.Rmd" class="external-link"><code>vignettes/misc.Rmd</code></a></small>
      <div class="d-none name"><code>misc.Rmd</code></div>
    </div>

    
    
<p>This vignette has some extra companion notes to the <em>Introduction
to <code>visiumStiched</code></em> main vignette.</p>
<div class="section level2">
<h2 id="load-data">Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h2>
<p>Let’s load the <code>spatialLIBD</code> package we’ll use in this
vignette.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/LieberInstitute/spatialLIBD" class="external-link">"spatialLIBD"</a></span><span class="op">)</span></span></code></pre></div>
<p>Now we can download the example <code>visiumStitched_brain</code>
data that includes normalized <code>logcounts</code>. We’ll define the
same example white matter marker genes.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Grab SpatialExperiment with normalized counts</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/fetch_data.html" class="external-link">fetch_data</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"visiumStitched_brain_spe"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2024-10-18 14:29:29.554226 loading file /github/home/.cache/R/BiocFileCache/25739445980_visiumStitched_brain_spe.rds%3Frlkey%3Dnq6a82u23xuu9hohr86oodwdi%26dl%3D1</span></span>
<span></span>
<span><span class="co">## Check that spe does contain the "logcounts" assay</span></span>
<span><span class="fu">assayNames</span><span class="op">(</span><span class="va">spe</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "counts"    "logcounts"</span></span>
<span></span>
<span><span class="co">## Define white matter marker genes</span></span>
<span><span class="va">wm_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MBP"</span>, <span class="st">"GFAP"</span>, <span class="st">"PLP1"</span>, <span class="st">"AQP4"</span><span class="op">)</span>, <span class="fu">rowData</span><span class="op">(</span><span class="va">spe</span><span class="op">)</span><span class="op">$</span><span class="va">gene_name</span><span class="op">)</span></span>
<span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="geometric-transformations-notes">Geometric transformations notes<a class="anchor" aria-label="anchor" href="#geometric-transformations-notes"></a>
</h2>
<p>As a <code>SpatialExperiment</code>, the stitched data you
constructed with <code><a href="../reference/build_SpatialExperiment.html">visiumStitched::build_SpatialExperiment()</a></code>
may need to be rotated or mirrored by group. This can be done using the
<code><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-rotate-mirror.html" class="external-link">SpatialExperiment::rotateObject()</a></code> or
<code><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-rotate-mirror.html" class="external-link">SpatialExperiment::mirrorObject()</a></code> functions. These
functions are useful in case the image needs to be transformed to reach
the preferred tissue orientation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Rotate image and gene-expression data by 180 degrees, plotting a combination</span></span>
<span><span class="co">## of white-matter genes</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/vis_gene.html" class="external-link">vis_gene</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-rotate-mirror.html" class="external-link">rotateObject</a></span><span class="op">(</span><span class="va">spe</span>, sample_id <span class="op">=</span> <span class="st">"Br2719"</span>, degrees <span class="op">=</span> <span class="fl">180</span><span class="op">)</span>,</span>
<span>    geneid <span class="op">=</span> <span class="va">wm_genes</span>,</span>
<span>    assayname <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>    is_stitched <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    spatial <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="misc_files/figure-html/rotate-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Mirror image and gene-expression data across a vertical axis, plotting a</span></span>
<span><span class="co">## combination of white-matter genes</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/vis_gene.html" class="external-link">vis_gene</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-rotate-mirror.html" class="external-link">mirrorObject</a></span><span class="op">(</span><span class="va">spe</span>, sample_id <span class="op">=</span> <span class="st">"Br2719"</span>, axis <span class="op">=</span> <span class="st">"v"</span><span class="op">)</span>,</span>
<span>    geneid <span class="op">=</span> <span class="va">wm_genes</span>,</span>
<span>    assayname <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>    is_stitched <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    spatial <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="misc_files/figure-html/mirror-1.png" width="700"></p>
<p>You might want to re-make these plots with
<code>spatial = TRUE</code> so you can see how the histology image gets
rotated and/or mirrored. For file size purposes of this vignette, here
we had to use <code>spatial = FALSE</code>.</p>
<div class="section level3">
<h3 id="a-note-on-normalization">A note on normalization<a class="anchor" aria-label="anchor" href="#a-note-on-normalization"></a>
</h3>
<p>As noted <a href="https://research.libd.org/visiumStitched/articles/visiumStitched.html#stitched-plotting" class="external-link">in
the main vignette</a>, library-size variation across spots can bias the
apparent spatial distribution of genes when raw counts are used. The
effect is often dramatic enough that spatial trends cannot be easily
seen across the stitched data until data is log-normalized. Instead of
performing normalization here, we’ll fetch the object with <a href="https://bioconductor.org/books/3.19/OSCA.basic/normalization.html#normalization-by-deconvolution" class="external-link">normalized</a>
counts from <code>spatialLIBD</code>, then plot a few white matter genes
as before:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot combination of normalized counts for some white-matter genes</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/vis_gene.html" class="external-link">vis_gene</a></span><span class="op">(</span></span>
<span>    <span class="va">spe</span>,</span>
<span>    geneid <span class="op">=</span> <span class="va">wm_genes</span>,</span>
<span>    assayname <span class="op">=</span> <span class="st">"logcounts"</span>,</span>
<span>    is_stitched <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    spatial <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="misc_files/figure-html/fetch_norm-1.png" width="700"></p>
<p>Recall the unnormalized version of this plot, which is not nearly as
clean:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot raw counts, which are noisier</span></span>
<span><span class="co">## Same plot we made before, but this time with no histology images</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/spatialLIBD/man/vis_gene.html" class="external-link">vis_gene</a></span><span class="op">(</span></span>
<span>    <span class="va">spe</span>,</span>
<span>    geneid <span class="op">=</span> <span class="va">wm_genes</span>,</span>
<span>    assayname <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>    is_stitched <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    spatial <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="misc_files/figure-html/unnorm_plot-1.png" width="700"></p>
<p>The actual normalization code for this example data is available <a href="https://github.com/LieberInstitute/visiumStitched_brain/blob/01eae0b12848b4ecbb6fe2dc9c07ad4257df3e47/code/03_stitching/02_build_SpatialExperiment.R#L43-L76" class="external-link">here</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="merging-overlapping-spots">Merging overlapping spots<a class="anchor" aria-label="anchor" href="#merging-overlapping-spots"></a>
</h2>
<p>In general, we recommend retaining all spots for downstream analysis,
even if that means including multiple spots per array coordinate. <a href="http://research.libd.org/visiumStitched/articles/visiumStitched.html#downstream-applications" class="external-link">We
show</a> that many software tools, such as BayesSpace and PRECAST, can
smoothly handle data in this format. However, given that having multiple
spots at the same array coordinates is atypical in Visium experiments,
we caution that it’s possible some software may break or not perform as
intended with stitched data. We provide the
<code><a href="../reference/merge_overlapping.html">merge_overlapping()</a></code> function to address this case.</p>
<p>In particular, <code><a href="../reference/merge_overlapping.html">merge_overlapping()</a></code> sums raw counts
across spots that overlap, ultimately producing a
<code>SpatialExperiment</code> with one spot per array coordinate.
<code>colData()</code> information, both discrete and continuous, is
taken from spots where <code>exclude_overlapping</code> is
<code>FALSE</code>. Note that the function can be quite memory-intensive
and time-consuming.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spe_merged</span> <span class="op">=</span> <span class="fu"><a href="../reference/merge_overlapping.html">merge_overlapping</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nicholas J. Eagles.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
